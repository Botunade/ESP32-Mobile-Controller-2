<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tank Controller (Web Dashboard)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #3b82f6; --success: #22c55e; --danger: #ef4444; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 600px; margin: 0 auto; -webkit-font-smoothing: antialiased; }
        h1 { font-size: 1.5rem; margin-bottom: 0.5rem; text-align: center; }
        .subtitle { text-align: center; color: #94a3b8; margin-bottom: 2rem; font-size: 0.9rem; }
        
        /* Layout */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .card { background: var(--card); padding: 16px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .full-width { grid-column: span 2; }
        
        /* Mode Switch */
        .mode-switch { display: flex; background: #334155; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .mode-btn { flex: 1; background: transparent; padding: 10px; border-radius: 8px; color: #94a3b8; font-size: 0.9rem; margin-bottom: 0; }
        .mode-btn.active { background: var(--card); color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Typography */
        .label { color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; display: block; }
        .value { font-size: 1.5rem; font-weight: 700; }
        .unit { font-size: 0.9rem; color: #64748b; font-weight: 400; }
        
        /* Controls */
        button { background: var(--accent); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer; width: 100%; transition: opacity 0.2s; margin-bottom: 10px; }
        button:active { opacity: 0.8; }
        button:disabled { background: #334155; color: #94a3b8; cursor: not-allowed; opacity: 1; }
        button.danger { background: var(--danger); }
        
        input { background: #020617; border: 1px solid #334155; color: white; padding: 12px; border-radius: 8px; width: 100%; font-size: 1.1rem; box-sizing: border-box; text-align: center; margin-bottom: 10px; }
        
        /* Chart Container */
        .chart-container { height: 250px; width: 100%; margin-top: 10px; }
        
        /* State Classes */
        .hidden { display: none !important; }
        .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #64748b; margin-right: 6px; }
        .connected .status-dot { background: var(--success); box-shadow: 0 0 8px var(--success); }
    </style>
</head>
<body>

    <h1>Tank Controller</h1>
    <p class="subtitle">Unified Web Dashboard</p>

    <!-- Mode Switch -->
    <div class="mode-switch">
        <button class="mode-btn active" onclick="setMode('wifi')">Wi-Fi (AP)</button>
        <button class="mode-btn" onclick="setMode('ble')">Bluetooth</button>
    </div>

    <!-- Connection Panel -->
    <div id="connectionPanel" class="card mb-4 text-center">
        <div style="margin-bottom: 20px;">
            <div id="statusIndicator" class="status-dot"></div>
            <span id="statusText" style="color: #94a3b8; font-size: 0.9rem;">Disconnected</span>
        </div>
        
        <!-- WIFI INPUTS -->
        <div id="wifiInputs">
            <input type="text" id="hostInput" value="192.168.4.1" placeholder="IP Address">
            <button id="connectBtn">Connect (HTTP)</button>
        </div>

        <!-- BLE INPUTS -->
        <div id="bleInputs" class="hidden">
            <button id="bleScanBtn">Scan & Connect</button>
        </div>
        
        <button id="disconnectBtn" class="danger hidden">Disconnect</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Live Data Grid -->
        <div class="grid">
            <div class="card">
                <span class="label">Water Level</span>
                <div class="value" id="levelDisplay">-- <span class="unit">%</span></div>
            </div>
            <div class="card">
                <span class="label">Pump Status</span>
                <div class="value" id="pumpDisplay">OFF</div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card full-width">
            <span class="label">Water Level History</span>
            <div class="chart-container">
                <canvas id="levelChart"></canvas>
            </div>
        </div>

        <!-- Controls -->
        <div class="card full-width">
            <span class="label">Control Limits</span>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <div>
                    <label class="label" style="font-size: 0.6rem;">Upper (Stop)</label>
                    <input type="number" id="setpointInput" placeholder="80" min="0" max="100">
                </div>
                <div>
                    <label class="label" style="font-size: 0.6rem;">Lower (Start)</label>
                    <input type="number" id="lowerLimitInput" placeholder="40" min="0" max="100">
                </div>
            </div>
            <button id="updateBtn" style="margin-top: 10px;">Update Control Limits</button>
            <p style="font-size: 0.8rem; color: #64748b; margin-top: 8px; text-align: center;">
                Range: <span id="currentLowerLimit">--</span>% - <span id="currentSetpoint">--</span>%
            </p>
        </div>

        <!-- Configuration Button -->
        <button id="configBtn" style="background: #334155;">‚öôÔ∏è Advanced Configuration</button>
    </div>

    <!-- Configuration Modal -->
    <div id="configModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: var(--card); border-radius: 16px; padding: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <h2 style="margin-top: 0; margin-bottom: 20px;">Configuration</h2>
            
            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">TANK GEOMETRY</h3>
                <div style="display: grid; gap: 10px;">
                    <div>
                        <label class="label">Tank Height (cm)</label>
                        <input type="number" id="cfg_tank_height" step="0.1">
                    </div>
                    <div>
                        <label class="label">Min Distance (cm)</label>
                        <input type="number" id="cfg_min_distance" step="0.1">
                    </div>
                    <div>
                        <label class="label">Max Distance (cm)</label>
                        <input type="number" id="cfg_max_distance" step="0.1">
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">CONTROL WINDOW</h3>
                <div style="display: grid; gap: 10px;">
                    <div>
                        <label class="label">Upper Limit (%) - STOP</label>
                        <input type="number" id="cfg_setpoint" step="0.1" min="0" max="100">
                    </div>
                    <div>
                        <label class="label">Lower Limit (%) - START</label>
                        <input type="number" id="cfg_lower_limit" step="0.1" min="0" max="100">
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 0.9rem; color: #94a3b8; margin-bottom: 10px;">VALVE OUTPUT</h3>
                <div style="display: grid; gap: 10px;">
                    <div>
                        <label class="label">Min Voltage (V)</label>
                        <input type="number" id="cfg_valve_min" step="0.01">
                    </div>
                    <div>
                        <label class="label">Max Voltage (V)</label>
                        <input type="number" id="cfg_valve_max" step="0.01">
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="saveConfigBtn" style="flex: 1; background: var(--success);">üíæ Save Configuration</button>
                <button id="closeConfigBtn" style="flex: 1; background: var(--danger);">‚úñ Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ========== CONFIG ==========
        const BLE_SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
        const BLE_STATUS_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";  
        const BLE_CONTROL_UUID = "885f8386-3532-4048-8167-25e21508246d"; 

        // ========== STATE ==========
        let state = {
            mode: 'wifi', // 'wifi' | 'ble'
            connected: false,
            device: null, // BLE device handle
            server: null,
            timer: null, // WiFi polling timer
            chart: null,
            bleChars: { status: null, control: null },
            apiUrl: '' // Base URL for WiFi API
        };

        const maxDataPoints = 50;

        // ========== UI ELEMENTS ==========
        const ui = {
            wifiInputs: document.getElementById('wifiInputs'),
            bleInputs: document.getElementById('bleInputs'),
            hostInput: document.getElementById('hostInput'),
            connectBtn: document.getElementById('connectBtn'),
            bleScanBtn: document.getElementById('bleScanBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            dashboard: document.getElementById('dashboard'),
            statusText: document.getElementById('statusText'),
            statusIndicator: document.getElementById('statusIndicator').parentElement,
            level: document.getElementById('levelDisplay'),
            pump: document.getElementById('pumpDisplay'),
            setpointInput: document.getElementById('setpointInput'),
            lowerLimitInput: document.getElementById('lowerLimitInput'),
            currentSetpoint: document.getElementById('currentSetpoint'),
            currentLowerLimit: document.getElementById('currentLowerLimit'),
            updateBtn: document.getElementById('updateBtn'),
            modeBtns: document.querySelectorAll('.mode-btn')
        };

        // Initialize API URL if served from ESP32
        if (window.location.protocol.startsWith('http')) {
            state.apiUrl = window.location.origin;
            ui.hostInput.value = window.location.host;
            ui.statusText.innerText = "Ready (Local Device)";
        }

        // ========== MODES ==========
        window.setMode = (mode) => {
            if (state.connected) disconnect();
            state.mode = mode;
            
            ui.modeBtns.forEach((btn, i) => {
                if ((mode === 'wifi' && i === 0) || (mode === 'ble' && i === 1)) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            if (mode === 'wifi') {
                ui.wifiInputs.classList.remove('hidden');
                ui.bleInputs.classList.add('hidden');
            } else {
                ui.wifiInputs.classList.add('hidden');
                ui.bleInputs.classList.remove('hidden');
            }
        };

        // ========== CHART ==========
        const ctx = document.getElementById('levelChart').getContext('2d');
        state.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(maxDataPoints).fill(''),
                datasets: [{
                    label: 'Level %', data: Array(maxDataPoints).fill(null),
                    borderColor: '#22d3ee', backgroundColor: 'rgba(34, 211, 238, 0.1)',
                    borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0
                }, {
                    label: 'Upper Limit', data: Array(maxDataPoints).fill(null),
                    borderColor: '#ef4444', borderWidth: 1, borderDash: [5, 5],
                    pointRadius: 0, fill: false
                }, {
                    label: 'Lower Limit', data: Array(maxDataPoints).fill(null),
                    borderColor: '#22c55e', borderWidth: 1, borderDash: [5, 5],
                    pointRadius: 0, fill: false
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { min: 0, max: 100, grid: { color: '#334155' } }, x: { display: false } },
                animation: false
            }
        });

        // ========== CONNECTION LOGIC ==========

        ui.connectBtn.addEventListener('click', async () => {
             // WiFi Connect
             if (ui.hostInput.value) {
                 state.apiUrl = ui.hostInput.value.startsWith('http') ? ui.hostInput.value : `http://${ui.hostInput.value}`;
             }
             
             ui.statusText.innerText = `Connecting to ${state.apiUrl}...`;
             try {
                 const res = await fetch(`${state.apiUrl}/status`, { signal: AbortSignal.timeout(2000) });
                 if (!res.ok) throw new Error("Status failed");
                 const data = await res.json();
                 
                 setConnected(true, `Connected to ${state.apiUrl}`);
                 updateDashboard(data);
                 
                 // Start polling
                 state.timer = setInterval(async () => {
                     try {
                         const r = await fetch(`${state.apiUrl}/status`);
                         const d = await r.json();
                         updateDashboard(d);
                     } catch(e) { console.log("Poll fail", e); }
                 }, 1000);

             } catch (e) {
                 console.error(e);
                 ui.statusText.innerText = "Connection Failed (Check IP / CORS)";
             }
        });

        ui.bleScanBtn.addEventListener('click', async () => {
            // BLE Connect
            try {
                ui.statusText.innerText = "Scanning...";
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Tank Controller BLE' }],
                    optionalServices: [BLE_SERVICE_UUID]
                });

                device.addEventListener('gattserverdisconnected', disconnect);
                state.device = device;

                ui.statusText.innerText = "Connecting BLE...";
                const server = await device.gatt.connect();
                state.server = server;
                
                const service = await server.getPrimaryService(BLE_SERVICE_UUID);
                state.bleChars.status = await service.getCharacteristic(BLE_STATUS_UUID);
                state.bleChars.control = await service.getCharacteristic(BLE_CONTROL_UUID);

                await state.bleChars.status.startNotifications();
                state.bleChars.status.addEventListener('characteristicvaluechanged', (e) => {
                    const str = new TextDecoder().decode(e.target.value);
                    try { updateDashboard(JSON.parse(str)); } catch(e){}
                });

                setConnected(true, `Connected to ${device.name}`);
            } catch (error) {
                console.error(error);
                ui.statusText.innerText = "BLE Failed";
            }
        });

        ui.disconnectBtn.addEventListener('click', disconnect);

        function disconnect() {
            if (state.timer) clearInterval(state.timer);
            if (state.device && state.device.gatt.connected) state.device.gatt.disconnect();
            
            state.connected = false;
            setConnected(false, "Disconnected");
        }

        function setConnected(connected, msg) {
            state.connected = connected;
            ui.statusText.innerText = msg;
            if (connected) {
                ui.statusIndicator.classList.add('connected');
                ui.wifiInputs.classList.add('hidden');
                ui.bleInputs.classList.add('hidden');
                ui.disconnectBtn.classList.remove('hidden');
                ui.dashboard.classList.remove('hidden');
            } else {
                ui.statusIndicator.classList.remove('connected');
                if (state.mode === 'wifi') ui.wifiInputs.classList.remove('hidden');
                 else ui.bleInputs.classList.remove('hidden');
                ui.disconnectBtn.classList.add('hidden');
                ui.dashboard.classList.add('hidden');
            }
        }

        // ========== UPDATE LOGIC ==========

        function updateDashboard(data) {
            ui.level.innerHTML = `${data.level_percent.toFixed(0)} <span class="unit">%</span>`;
            
            // Pump Status Styling
            if (data.pump_on) {
                ui.pump.innerText = "ON";
                ui.pump.style.color = "var(--success)";
            } else {
                ui.pump.innerText = "OFF";
                ui.pump.style.color = "#64748b";
            }

            ui.currentSetpoint.innerText = data.setpoint_percent.toFixed(0);
            ui.currentLowerLimit.innerText = data.lower_limit.toFixed(0);

            if (ui.setpointInput.value === '') ui.setpointInput.placeholder = data.setpoint_percent;
            if (ui.lowerLimitInput.value === '') ui.lowerLimitInput.placeholder = data.lower_limit;

            const chart = state.chart;
            if (chart.data.labels.length >= maxDataPoints) {
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
                chart.data.datasets[2].data.shift();
            }
            chart.data.datasets[0].data.push(data.level_percent);
            chart.data.datasets[1].data.push(data.setpoint_percent);
            chart.data.datasets[2].data.push(data.lower_limit);
            chart.update('none'); 
        }

        ui.updateBtn.addEventListener('click', async () => {
             const setpoint = parseFloat(ui.setpointInput.value) || parseFloat(ui.setpointInput.placeholder);
             const lowerLimit = parseFloat(ui.lowerLimitInput.value) || parseFloat(ui.lowerLimitInput.placeholder);
             
             if (isNaN(setpoint) || isNaN(lowerLimit)) return;

             ui.updateBtn.innerText = "Saving...";
             ui.updateBtn.disabled = true;

             try {
                 const payload = { setpoint, lower_limit: lowerLimit };
                 if (state.mode === 'wifi') {
                     const ip = ui.hostInput.value;
                     await fetch(`http://${ip}/pid`, {
                         method: 'POST',
                         headers: {'Content-Type': 'application/json'},
                         body: JSON.stringify(payload)
                     });
                 } else {
                     await state.bleChars.control.writeValue(new TextEncoder().encode(JSON.stringify(payload)));
                 }
                 
                 setTimeout(() => {
                     ui.updateBtn.innerText = "Update Control Limits"; 
                     ui.updateBtn.disabled = false;
                     ui.setpointInput.value = '';
                     ui.lowerLimitInput.value = '';
                 }, 500);

             } catch (e) {
                 alert("Update failed");
                 ui.updateBtn.disabled = false;
             }
        });

        // ========== CONFIGURATION MODAL ==========
        const configModal = document.getElementById('configModal');
        const configBtn = document.getElementById('configBtn');
        const closeConfigBtn = document.getElementById('closeConfigBtn');
        const saveConfigBtn = document.getElementById('saveConfigBtn');

        configBtn.addEventListener('click', async () => {
            try {
                if (state.mode === 'wifi') {
                    // Wi-Fi: Fetch current config from ESP32
                    const ip = ui.hostInput.value;
                    ui.statusText.innerText = 'Loading configuration...';
                    
                    const res = await fetch(`http://${ip}/config`, {
                        signal: AbortSignal.timeout(3000)
                    });
                    
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    
                    const data = await res.json();
                    
                    // Populate form
                    document.getElementById('cfg_tank_height').value = data.tank_height_cm || '';
                    document.getElementById('cfg_min_distance').value = data.min_distance_cm || '';
                    document.getElementById('cfg_max_distance').value = data.max_distance_cm || '';
                    document.getElementById('cfg_setpoint').value = data.setpoint || '';
                    document.getElementById('cfg_lower_limit').value = data.lower_limit || '';
                    
                    ui.statusText.innerText = `Connected to ${ip}`;
                } else {
                    // BLE: Show empty form (BLE doesn't support reading config)
                    alert('‚ÑπÔ∏è BLE Mode: Enter values manually. Current values are not available via Bluetooth.');
                }
                
                configModal.classList.remove('hidden');
            } catch (e) {
                console.error('Config load error:', e);
                alert(`‚ùå Failed to load configuration: ${e.message}`);
                if (state.mode === 'wifi') {
                    ui.statusText.innerText = `Connected to ${ui.hostInput.value}`;
                }
            }
        });

        closeConfigBtn.addEventListener('click', () => {
            configModal.classList.add('hidden');
        });

        saveConfigBtn.addEventListener('click', async () => {
            try {
                const payload = {
                    tank_height_cm: parseFloat(document.getElementById('cfg_tank_height').value),
                    min_distance_cm: parseFloat(document.getElementById('cfg_min_distance').value),
                    max_distance_cm: parseFloat(document.getElementById('cfg_max_distance').value),
                    setpoint: parseFloat(document.getElementById('cfg_setpoint').value),
                    lower_limit: parseFloat(document.getElementById('cfg_lower_limit').value)
                };

                if (state.mode === 'wifi') {
                    // Wi-Fi: HTTP POST
                    const ip = ui.hostInput.value;
                    const res = await fetch(`http://${ip}/config`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (res.ok) {
                        alert('‚úÖ Configuration saved successfully!');
                        configModal.classList.add('hidden');
                    } else {
                        alert('‚ùå Failed to save configuration');
                    }
                } else {
                    // BLE: Write to control characteristic
                    if (!state.bleChars.control) {
                        alert('‚ùå BLE not connected');
                        return;
                    }
                    
                    const jsonStr = JSON.stringify(payload);
                    await state.bleChars.control.writeValue(new TextEncoder().encode(jsonStr));
                    alert('‚úÖ Configuration saved via Bluetooth!');
                    configModal.classList.add('hidden');
                }
            } catch (e) {
                console.error('Config save error:', e);
                alert(`‚ùå Error saving configuration: ${e.message}`);
            }
        });
    </script>
</body>
</html>
